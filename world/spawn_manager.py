# world/spawn_manager.py
# ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ wave / timing ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏à‡∏≤‡∏Å enemy_spawns ‡πÉ‡∏ô LevelData

from __future__ import annotations

from typing import Any, Dict, List

from entities.enemy_node import EnemyNode
from entities.born_effect_node import BornEffectNode   # üí° ‡πÄ‡∏û‡∏¥‡πà‡∏° import ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
from world.level_data import LevelData


class SpawnManager:
    def __init__(self, game, level_data: LevelData,
                 enemy_group, all_sprites_group) -> None:
        """
        game             = GameApp
        level_data       = LevelData ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å load_level("level01")
        enemy_group      = pygame.sprite.Group() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π
        all_sprites_group= group ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å sprite
        """
        self.game = game
        self.enemy_group = enemy_group
        self.all_sprites_group = all_sprites_group

        self._elapsed: float = 0.0   # ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏î‡πà‡∏≤‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
        self._schedule: List[Dict[str, Any]] = []

        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á spawn ‡∏à‡∏≤‡∏Å enemy_spawns ‡πÉ‡∏ô level_data
        for spawn in level_data.enemy_spawns:
            spawn_time = float(spawn.get("spawn_time", 0.0))  # ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡∏¥‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏à‡∏£‡∏¥‡∏á
            enemy_type = spawn["type"]
            pos = tuple(spawn["pos"])

            # ---------- Event 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á BornEffectNode ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 1.5 ‡∏ß‡∏¥ ----------
            # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏ñ‡πâ‡∏≤ spawn_time == 0 ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á BornEffectNode
            if spawn_time > 0.0:
                effect_time = max(0.0, spawn_time - 1.5)
                self._schedule.append({
                    "time": effect_time,
                    "kind": "born_effect",
                    "type": enemy_type,
                    "pos": pos,
                    "spawned": False,
                })

            # ---------- Event 2: ‡∏™‡∏£‡πâ‡∏≤‡∏á Enemy ‡∏à‡∏£‡∏¥‡∏á (‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ) ----------
            self._schedule.append({
                "time": spawn_time,
                "kind": "enemy",
                "type": enemy_type,
                "pos": pos,
                "spawned": False,
            })


    @property
    def is_finished(self) -> bool:
        """‡∏Ñ‡∏∑‡∏ô True ‡∏ñ‡πâ‡∏≤ spawn ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏£‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß)"""
        if not self._schedule:
            return True
        return all(entry["spawned"] for entry in self._schedule)

    def reset(self) -> None:
        """‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ spawn (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏î‡πà‡∏≤‡∏ô)"""
        self._elapsed = 0.0
        for entry in self._schedule:
            entry["spawned"] = False

    def update(self, dt: float) -> None:
        """‡πÉ‡∏´‡πâ GameScene ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏ü‡∏£‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á"""
        if not self._schedule:
            return

        self._elapsed += dt

        for entry in self._schedule:
            if entry["spawned"]:
                continue

            # ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤ spawn ‚Üí ‡∏´‡∏¢‡∏∏‡∏î loop ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ list ‡∏ñ‡∏π‡∏Å sort ‡πÅ‡∏•‡πâ‡∏ß)
            if self._elapsed < entry["time"]:
                break

            # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏ô‡∏¥‡∏î event
            if entry["kind"] == "born_effect":
                # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π (‡πÉ‡∏™‡πà‡πÅ‡∏Ñ‡πà all_sprites ‡∏û‡∏≠)
                BornEffectNode(
                    self.game,
                    entry["pos"],
                    self.all_sprites_group,
                )

            elif entry["kind"] == "enemy":
                # ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á EnemyNode ‡πÉ‡∏™‡πà group
                EnemyNode(
                    self.game,
                    entry["pos"],
                    self.all_sprites_group,
                    self.enemy_group,
                    enemy_id=entry["type"],
                )

            entry["spawned"] = True
